<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProRef - Product Refinement Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/env-alerts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/test-cases.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tickets-table.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/new-ui.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/button-fix-clean.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ ProRef - Product Refinement Assistant</h1>
            <p>Fetch tickets and generate test cases</p>
        </header>

        {% if missing_vars %}
        <div class="alert alert-warning">
            <h2>‚ö†Ô∏è Missing Environment Variables</h2>
            <p>Please set the following environment variables in your <code>.env</code> file:</p>
            <ul>
                {% for var in missing_vars %}
                <li>{{ var }}</li>
                {% endfor %}
            </ul>
            <p>See <a href="#" onclick="showEnvInstructions()">Environment Setup Instructions</a> for help.</p>
        </div>
        
        <div id="env-instructions" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="hideEnvInstructions()">&times;</span>
                <h2>Environment Setup Instructions</h2>
                <p>Create or edit the <code>.env</code> file in the project root directory with the following content:</p>
                <pre><code># Google API Configuration
GOOGLE_API_KEY=your-google-api-key-here

# Jira Configuration
JIRA_BASE_URL=https://your-organization.atlassian.net
JIRA_USER=your-jira-email@example.com
JIRA_API_TOKEN=your-jira-api-token

# Project/Sprint Configuration (uncomment and set one of these options)
JIRA_PROJECT=YOUR_PROJECT_KEY
JIRA_SPRINT="Your Sprint Name"
# JIRA_JQL=project = YOUR_PROJECT AND Sprint = "Your Sprint Name" ORDER BY updated DESC

# Optional Model Configuration
MODEL_QUESTIONS=gemini-1.5-pro
MODEL_TESTCASES=gemini-1.5-flash</code></pre>
            </div>
        </div>
        {% endif %}

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Fetch Backlog Section -->
            <div class="section" id="fetch-backlog-section">
                <div class="section-header">
                    <h2>üì• Fetch Backlog</h2>
                    <button id="run-fetch-backlog" class="run-button" {% if missing_vars %}disabled{% endif %}>Fetch Tickets</button>
                </div>
                
                <div class="section-status">
                    <span class="status-label">Status:</span>
                    <span class="status-value" id="fetch-backlog-status">{{ process_status['fetch_backlog']['status'] }}</span>
                </div>
                
                <div class="output-area" id="fetch-backlog-output-area">
                    <h3>Output</h3>
                    <div class="output-container" id="fetch-backlog-output">
                        {% for line in process_status['fetch_backlog']['output'] %}
                            <div>{{ line }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Tickets List Section -->
            <div class="section" id="tickets-section">
                <div class="section-header">
                    <h2>üé´ Tickets</h2>
                </div>
                
                <div class="tickets-list">
                    {% if tickets_data %}
                        {% for ticket in tickets_data %}
                            <div class="ticket-item" id="ticket-{{ ticket.jira_key }}">
                                <div class="ticket-header" onclick="expandTicket('{{ ticket.jira_key }}')">
                                    <div class="ticket-title">
                                        <h3>{{ ticket.jira_key }} - {{ ticket.title }}</h3>
                                        <span class="ticket-type">{{ ticket.issue_type }}</span>
                                        <span class="ticket-status">{{ ticket.status }}</span>
                                    </div>
                                    <div class="ticket-actions" onclick="event.stopPropagation();">
                                        {% if not ticket.has_test_cases %}
                                            <button class="generate-button" onclick="generateTestCases('{{ ticket.jira_key }}')">Generate Test Cases</button>
                                        {% else %}
                                            <span class="test-cases-badge">‚úÖ Test Cases Generated</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="ticket-details" id="details-{{ ticket.jira_key }}" style="display: none;">
                                    <div class="ticket-description">
                                        <h4>Description</h4>
                                        <div class="description-content">{{ ticket.description }}</div>
                                    </div>
                                    
                                    <div class="ticket-test-cases" id="test-cases-{{ ticket.jira_key }}">
                                        {% if ticket.test_cases %}
                                            <h4>Test Cases</h4>
                                            {% for test_case in ticket.test_cases %}
                                                <div class="test-case" id="test-case-{{ test_case.id }}">
                                                    <div class="test-case-view">
                                                        <div class="test-case-header">
                                                            <h5>Test Case {{ loop.index }}</h5>
                                                            <button class="edit-test-case-btn" onclick="editTestCase('{{ test_case.id }}')">‚úèÔ∏è Edit</button>
                                                        </div>
                                                        <p><strong>Scenario:</strong> <em>{{ test_case.scenario }}</em></p>
                                                        <p><strong>Action:</strong> <em>{{ test_case.action }}</em></p>
                                                        <p><strong>Expected behavior:</strong> <em>{{ test_case.expected_behavior }}</em></p>
                                                    </div>
                                                    <div class="test-case-edit" style="display: none;">
                                                        <div class="test-case-header">
                                                            <h5>Edit Test Case {{ loop.index }}</h5>
                                                            <div>
                                                                <button class="cancel-edit-btn" onclick="cancelEditTestCase('{{ test_case.id }}')">Cancel</button>
                                                                <button class="save-test-case-btn" onclick="saveTestCase('{{ test_case.id }}')">Save</button>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="scenario-{{ test_case.id }}">Scenario:</label>
                                                            <textarea id="scenario-{{ test_case.id }}" class="form-control">{{ test_case.scenario }}</textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="action-{{ test_case.id }}">Action:</label>
                                                            <textarea id="action-{{ test_case.id }}" class="form-control">{{ test_case.action }}</textarea>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="expected-{{ test_case.id }}">Expected behavior:</label>
                                                            <textarea id="expected-{{ test_case.id }}" class="form-control">{{ test_case.expected_behavior }}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        {% elif ticket.has_test_cases %}
                                            <div class="loading" id="loading-{{ ticket.jira_key }}">
                                                <p>Loading test cases...</p>
                                            </div>
                                        {% else %}
                                            <p class="no-test-cases">No test cases generated yet.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% elif process_status['fetch_backlog']['tickets'] %}
                        {% for ticket in process_status['fetch_backlog']['tickets'] %}
                            <div class="ticket-item" id="ticket-{{ ticket.jira_key }}">
                                <div class="ticket-header" onclick="expandTicket('{{ ticket.jira_key }}')">
                                    <div class="ticket-title">
                                        <h3>{{ ticket.jira_key }} - {{ ticket.title }}</h3>
                                        <span class="ticket-type">{{ ticket.issue_type }}</span>
                                        <span class="ticket-status">{{ ticket.status }}</span>
                                    </div>
                                    <div class="ticket-actions" onclick="event.stopPropagation();">
                                        <button class="generate-button" onclick="generateTestCases('{{ ticket.jira_key }}')">Generate Test Cases</button>
                                    </div>
                                </div>
                                
                                <div class="ticket-details" id="details-{{ ticket.jira_key }}" style="display: none;">
                                    <div class="ticket-test-cases" id="test-cases-{{ ticket.jira_key }}">
                                        <p class="no-test-cases">No test cases generated yet.</p>
                                    </div>
                                    <!-- Dedicated container for the Send to Jira button -->
                                    <div class="jira-button-container" id="jira-button-{{ ticket.jira_key }}"></div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-tickets">No tickets fetched yet. Click the "Fetch Tickets" button to get started.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug utility function for development
        function debugLog(message, data) {
            const timestamp = new Date().toISOString().substr(11, 8);
            if (data) {
                console.log(`[${timestamp}] üîç ${message}`, data);
            } else {
                console.log(`[${timestamp}] üîç ${message}`);
            }
        }
        
        // Show/hide environment instructions
        function showEnvInstructions() {
            document.getElementById('env-instructions').style.display = 'block';
        }
        
        function hideEnvInstructions() {
            document.getElementById('env-instructions').style.display = 'none';
        }
        
        // Expand/collapse ticket details
        function expandTicket(ticketId) {
            const detailsEl = document.getElementById('details-' + ticketId);
            const ticketItem = document.getElementById('ticket-' + ticketId);
            
            if (detailsEl.style.display === 'none') {
                detailsEl.style.display = 'block';
                ticketItem.classList.add('expanded');
                fetchTestCasesIfNeeded(ticketId);
            } else {
                detailsEl.style.display = 'none';
                ticketItem.classList.remove('expanded');
            }
        }
        
        // Fetch test cases if they exist but aren't loaded yet
        function fetchTestCasesIfNeeded(ticketId) {
            const testCasesEl = document.getElementById('test-cases-' + ticketId);
            const loadingEl = document.getElementById('loading-' + ticketId);
            
            if (loadingEl) {
                // Test cases exist but aren't loaded yet
                fetch('/get_test_cases/' + ticketId)
                    .then(response => response.json())
                    .then(data => {
                        if (data.test_cases && data.test_cases.length > 0) {
                            let html = '<h4>Test Cases</h4>';                                    data.test_cases.forEach((testCase, index) => {
                                        // Explicitly convert to boolean to handle both string 'true'/'false' and boolean true/false
                                        const isEdited = testCase.edited === true || testCase.edited === 'true' || testCase.edited === 1;
                                        html += `
                                            <div class="test-case" id="test-case-${testCase.id}" data-edited="${isEdited}">
                                                <div class="test-case-view">
                                                    <div class="test-case-header">
                                                        <h5>Test Case ${index + 1} ${isEdited ? '<span class="edited-flag">(Edited)</span>' : ''}</h5>
                                                        <button class="edit-test-case-btn" onclick="editTestCase('${testCase.id}')">Edit</button>
                                                    </div>
                                                    <p><strong>Scenario:</strong> <em>${testCase.scenario}</em></p>
                                                    <p><strong>Action:</strong> <em>${testCase.action}</em></p>
                                                    <p><strong>Expected behavior:</strong> <em>${testCase.expected_behavior}</em></p>
                                                </div>
                                                <div class="test-case-edit" style="display: none;">
                                                    <div class="test-case-header">
                                                        <h5>Edit Test Case ${index + 1}</h5>
                                                        <div>
                                                            <button class="cancel-edit-btn" onclick="cancelEditTestCase('${testCase.id}')">Cancel</button>
                                                            <button class="save-test-case-btn" onclick="saveTestCase('${testCase.id}')">Save</button>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="scenario-${testCase.id}">Scenario:</label>
                                                        <textarea id="scenario-${testCase.id}" class="form-control">${testCase.scenario}</textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="action-${testCase.id}">Action:</label>
                                                        <textarea id="action-${testCase.id}" class="form-control">${testCase.action}</textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="expected-${testCase.id}">Expected behavior:</label>
                                                        <textarea id="expected-${testCase.id}" class="form-control">${testCase.expected_behavior}</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    
                                    // First, set the HTML content without the button
                                    testCasesEl.innerHTML = html;
                                    
                                    // Then create and add the Send to Jira button as a separate DOM element
                                    const jiraContainer = document.createElement('div');
                                    jiraContainer.className = 'send-to-jira-container';
                                    
                                    const jiraButton = document.createElement('button');
                                    jiraButton.className = 'send-to-jira-btn';
                                    jiraButton.textContent = 'Send Test Cases to Jira';
                                    jiraButton.onclick = function() { sendToJira(ticketId); };
                                    
                                    jiraContainer.appendChild(jiraButton);
                                    testCasesEl.appendChild(jiraContainer);
                                    
                                    console.log("Added Send to Jira button for ticket", ticketId);
                        } else {
                            testCasesEl.innerHTML = '<p class="no-test-cases">No test cases found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching test cases:', error);
                        testCasesEl.innerHTML = '<p class="error">Error loading test cases.</p>';
                    });
            }
        }
        
        // Generate test cases for a ticket
        function generateTestCases(ticketId) {
            const generateBtn = document.querySelector('#ticket-' + ticketId + ' .generate-button');
            const testCasesEl = document.getElementById('test-cases-' + ticketId);
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            testCasesEl.innerHTML = '<div class="loading"><p>Generating test cases...</p></div>';
            
            // Expand ticket details if not already expanded
            const detailsEl = document.getElementById('details-' + ticketId);
            const ticketItem = document.getElementById('ticket-' + ticketId);
            const expandBtn = ticketItem.querySelector('.expand-button');
            
            if (detailsEl.style.display === 'none') {
                detailsEl.style.display = 'block';
                expandBtn.textContent = '‚ñ≤';
            }
            
            fetch('/generate_test_cases/' + ticketId, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Get updated test cases for this ticket
                        fetch('/get_test_cases/' + ticketId)
                            .then(response => response.json())
                            .then(data => {
                                if (data.test_cases && data.test_cases.length > 0) {
                                    let html = '<h4>Test Cases</h4>';
                                    data.test_cases.forEach((testCase, index) => {
                                        // Explicitly convert to boolean to handle both string 'true'/'false' and boolean true/false
                                        const isEdited = testCase.edited === true || testCase.edited === 'true' || testCase.edited === 1;
                                        html += `
                                            <div class="test-case" id="test-case-${testCase.id}" data-edited="${isEdited}">
                                                <div class="test-case-view">
                                                    <div class="test-case-header">
                                                        <h5>Test Case ${index + 1} ${isEdited ? '<span class="edited-flag">(Edited)</span>' : ''}</h5>
                                                        <button class="edit-test-case-btn" onclick="editTestCase('${testCase.id}')">Edit</button>
                                                    </div>
                                                    <p><strong>Scenario:</strong> <em>${testCase.scenario}</em></p>
                                                    <p><strong>Action:</strong> <em>${testCase.action}</em></p>
                                                    <p><strong>Expected behavior:</strong> <em>${testCase.expected_behavior}</em></p>
                                                </div>
                                                <div class="test-case-edit" style="display: none;">
                                                    <div class="test-case-header">
                                                        <h5>Edit Test Case ${index + 1}</h5>
                                                        <div>
                                                            <button class="cancel-edit-btn" onclick="cancelEditTestCase('${testCase.id}')">Cancel</button>
                                                            <button class="save-test-case-btn" onclick="saveTestCase('${testCase.id}')">Save</button>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="scenario-${testCase.id}">Scenario:</label>
                                                        <textarea id="scenario-${testCase.id}" class="form-control">${testCase.scenario}</textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="action-${testCase.id}">Action:</label>
                                                        <textarea id="action-${testCase.id}" class="form-control">${testCase.action}</textarea>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="expected-${testCase.id}">Expected behavior:</label>
                                                        <textarea id="expected-${testCase.id}" class="form-control">${testCase.expected_behavior}</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    });
                                    
                                    // First, set the HTML content without the button
                                    testCasesEl.innerHTML = html;
                                    
                                    // Then create and add the Send to Jira button as a separate DOM element
                                    const jiraContainer = document.createElement('div');
                                    jiraContainer.className = 'send-to-jira-container';
                                    
                                    const jiraButton = document.createElement('button');
                                    jiraButton.id = `send-to-jira-btn-main-${ticketId}`;
                                    jiraButton.className = 'send-to-jira-btn';
                                    jiraButton.textContent = 'Send Test Cases to Jira';
                                    
                                    // Use addEventListener for better event handling
                                    jiraButton.addEventListener('click', function() {
                                        console.log(`Main Jira button clicked for ticket ${ticketId}`);
                                        sendToJira(ticketId);
                                    });
                                    
                                    jiraContainer.appendChild(jiraButton);
                                    testCasesEl.appendChild(jiraContainer);
                                    
                                    console.log("Added Send to Jira button for ticket", ticketId);
                                    
                                    // Update the generate button to show badge
                                    const actionsEl = document.querySelector('#ticket-' + ticketId + ' .ticket-actions');
                                    actionsEl.innerHTML = `
                                        <span class="test-cases-badge">‚úÖ Test Cases Generated</span>
                                    `;
                                } else {
                                    testCasesEl.innerHTML = '<p class="no-test-cases">No test cases found.</p>';
                                    generateBtn.disabled = false;
                                    generateBtn.textContent = 'Generate Test Cases';
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching test cases:', error);
                                testCasesEl.innerHTML = '<p class="error">Error loading test cases.</p>';
                                generateBtn.disabled = false;
                                generateBtn.textContent = 'Generate Test Cases';
                            });
                    } else {
                        testCasesEl.innerHTML = `<p class="error">Error: ${data.message}</p>`;
                        generateBtn.disabled = false;
                        generateBtn.textContent = 'Try Again';
                    }
                })
                .catch(error => {
                    console.error('Error generating test cases:', error);
                    testCasesEl.innerHTML = '<p class="error">Error generating test cases. Please try again.</p>';
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Try Again';
                });
        }
        
        // Test case edit functions
        function editTestCase(testCaseId) {
            const testCaseEl = document.getElementById('test-case-' + testCaseId);
            const viewEl = testCaseEl.querySelector('.test-case-view');
            const editEl = testCaseEl.querySelector('.test-case-edit');
            
            // Hide view mode, show edit mode
            viewEl.style.display = 'none';
            editEl.style.display = 'block';
        }
        
        function cancelEditTestCase(testCaseId) {
            const testCaseEl = document.getElementById('test-case-' + testCaseId);
            const viewEl = testCaseEl.querySelector('.test-case-view');
            const editEl = testCaseEl.querySelector('.test-case-edit');
            
            // Reset form values to original
            const scenarioInput = document.getElementById('scenario-' + testCaseId);
            const actionInput = document.getElementById('action-' + testCaseId);
            const expectedInput = document.getElementById('expected-' + testCaseId);
            
            // Get original values from the view mode
            const scenarioOrig = viewEl.querySelector('p:nth-child(2) em').textContent;
            const actionOrig = viewEl.querySelector('p:nth-child(3) em').textContent;
            const expectedOrig = viewEl.querySelector('p:nth-child(4) em').textContent;
            
            // Reset inputs to original values
            scenarioInput.value = scenarioOrig;
            actionInput.value = actionOrig;
            expectedInput.value = expectedOrig;
            
            // Hide edit mode, show view mode
            editEl.style.display = 'none';
            viewEl.style.display = 'block';
        }
        
        function saveTestCase(testCaseId) {
            const testCaseEl = document.getElementById('test-case-' + testCaseId);
            const viewEl = testCaseEl.querySelector('.test-case-view');
            const editEl = testCaseEl.querySelector('.test-case-edit');
            
            // Get form values
            const scenario = document.getElementById('scenario-' + testCaseId).value;
            const action = document.getElementById('action-' + testCaseId).value;
            const expected = document.getElementById('expected-' + testCaseId).value;
            
            // Validate form
            if (!scenario.trim() || !action.trim() || !expected.trim()) {
                alert('Please fill in all fields');
                return;
            }
            
            // Show loading state
            const saveBtn = testCaseEl.querySelector('.save-test-case-btn');
            const cancelBtn = testCaseEl.querySelector('.cancel-edit-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            cancelBtn.disabled = true;
            
            // Send update to server
            fetch('/update_test_case/' + testCaseId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    scenario: scenario,
                    action: action,
                    expected_behavior: expected
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the view with new values
                    viewEl.querySelector('p:nth-child(2) em').textContent = scenario;
                    viewEl.querySelector('p:nth-child(3) em').textContent = action;
                    viewEl.querySelector('p:nth-child(4) em').textContent = expected;
                    
                    // Mark as edited in the data attribute
                    testCaseEl.setAttribute('data-edited', 'true');
                    
                    // Update the edited flag in the header if it wasn't already set
                    const headerEl = viewEl.querySelector('.test-case-header h5');
                    if (!headerEl.innerHTML.includes('(Edited)')) {
                        headerEl.innerHTML = headerEl.innerHTML + ' <span class="edited-flag">(Edited)</span>';
                    }
                    
                    // Show view mode
                    editEl.style.display = 'none';
                    viewEl.style.display = 'block';
                } else {
                    // Show error
                    alert('Error: ' + data.message);
                    
                    // Reset buttons
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                    cancelBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error updating test case:', error);
                alert('Error updating test case. Please try again.');
                
                // Reset buttons
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
                cancelBtn.disabled = false;
            });
        }
        
        // Send test cases to Jira
        function sendToJira(ticketId) {
            debugLog(`sendToJira called for ticket: ${ticketId}`);
            
            // Use the clean implementation in button-fix-clean.js
            if (window.sendToJiraAPI) {
                window.sendToJiraAPI(ticketId);
            } else {
                debugLog("‚ùå sendToJiraAPI function not found, falling back to default implementation");
                
                // Make API request directly
                fetch(`/send_to_jira/${ticketId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        debugLog("‚úÖ Successfully sent to Jira");
                        alert("Successfully sent test cases to Jira!");
                    } else {
                        debugLog("‚ùå Error from server:", data.message);
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    debugLog('‚ùå Error sending to Jira:', error);
                    alert('Error sending test cases to Jira. Please try again.');
                });
            }
        }
        
        // Fetch backlog
        document.getElementById('run-fetch-backlog').addEventListener('click', function() {
            this.disabled = true;
            this.textContent = 'Fetching...';
            
            const statusEl = document.getElementById('fetch-backlog-status');
            statusEl.textContent = 'running';
            
            const outputEl = document.getElementById('fetch-backlog-output');
            outputEl.innerHTML = '<div>Fetching tickets from Jira...</div>';
            
            fetch('/run/fetch_backlog', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'started') {
                        pollFetchStatus();
                    } else {
                        statusEl.textContent = 'failed';
                        this.disabled = false;
                        this.textContent = 'Fetch Tickets';
                        showError('Failed to start fetch process');
                    }
                })
                .catch(error => {
                    console.error('Error fetching backlog:', error);
                    statusEl.textContent = 'failed';
                    this.disabled = false;
                    this.textContent = 'Fetch Tickets';
                    showError(`Error starting fetch: ${error.message}`);
                });
        });
        
        // Function to show error message in the UI
        function showError(message) {
            console.error(message);
            // Create error div if it doesn't exist
            let errorDiv = document.getElementById('error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'error-message';
                errorDiv.className = 'alert alert-error';
                document.querySelector('.main-content').prepend(errorDiv);
            }
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            errorDiv.style.display = 'block';
            
            // Hide after 10 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }
        
        // New function specifically for polling fetch_backlog status
        function pollFetchStatus() {
            console.log('Polling fetch_backlog status...');
            
            fetch('/status/fetch_backlog')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Fetch status:', data.status, 'Ticket count:', data.tickets ? data.tickets.length : 0);
                    
                    // Update status display
                    const statusEl = document.getElementById('fetch-backlog-status');
                    statusEl.textContent = data.status;
                    
                    // Update output display
                    const outputEl = document.getElementById('fetch-backlog-output');
                    outputEl.innerHTML = '';
                    
                    if (data.output && Array.isArray(data.output)) {
                        data.output.forEach(line => {
                            const div = document.createElement('div');
                            div.textContent = line;
                            outputEl.appendChild(div);
                        });
                        // Scroll to bottom
                        outputEl.scrollTop = outputEl.scrollHeight;
                    }
                    
                    // If completed and we have tickets, update the tickets display
                    if (data.status === 'completed') {
                        if (data.tickets && data.tickets.length > 0) {
                            console.log('Fetch completed with', data.tickets.length, 'tickets - updating display');
                            updateTicketsDisplay(data.tickets);
                        } else {
                            console.warn('Fetch completed but no tickets found in response');
                            showError('Fetch completed but no tickets were found. Check the output for details.');
                        }
                    }
                    
                    // Continue polling if still running
                    if (data.status === 'running') {
                        setTimeout(pollFetchStatus, 1000);
                    } else {
                        // Re-enable the run button
                        const button = document.getElementById('run-fetch-backlog');
                        button.disabled = false;
                        button.textContent = 'Fetch Tickets';
                    }
                })
                .catch(error => {
                    console.error('Error polling fetch status:', error);
                    showError(`Error checking fetch status: ${error.message}`);
                    setTimeout(pollFetchStatus, 2000); // Longer delay on error
                });
        }
        
        // New function to update the tickets display
        function updateTicketsDisplay(tickets) {
            console.log('Updating tickets display with', tickets.length, 'tickets');
            
            const ticketsSection = document.getElementById('tickets-section');
            const ticketsList = ticketsSection.querySelector('.tickets-list');
            
            // Create HTML from ticket data
            if (tickets && tickets.length > 0) {
                let html = '';
                tickets.forEach(ticket => {                    html += `
                    <div class="ticket-item" id="ticket-${ticket.jira_key}">
                        <div class="ticket-header" onclick="expandTicket('${ticket.jira_key}')">
                            <div class="ticket-title">
                                <h3>${ticket.jira_key} - ${ticket.title}</h3>
                                <span class="ticket-type">${ticket.issue_type}</span>
                                <span class="ticket-status">${ticket.status}</span>
                            </div>
                            <div class="ticket-actions" onclick="event.stopPropagation();">
                                <button class="generate-button" onclick="generateTestCases('${ticket.jira_key}')">Generate Test Cases</button>
                            </div>
                        </div>
                        
                        <div class="ticket-details" id="details-${ticket.jira_key}" style="display: none;">
                            <div class="ticket-description">
                                <h4>Description</h4>
                                <div class="description-content" id="description-${ticket.jira_key}">Loading...</div>
                            </div>
                            <div class="ticket-test-cases" id="test-cases-${ticket.jira_key}">
                                <p class="no-test-cases">No test cases generated yet.</p>
                            </div>
                        </div>
                    </div>
                    `;
                });
                
                ticketsList.innerHTML = html;
                
                // After updating the DOM, fetch the full ticket details including descriptions
                fetch('/get_tickets')
                    .then(response => response.json())
                    .then(fullTickets => {
                        console.log('Retrieved full ticket details:', fullTickets.length);
                        updateTicketsWithData(fullTickets);
                    })
                    .catch(error => {
                        console.error('Error fetching full ticket details:', error);
                    });
            } else {
                ticketsList.innerHTML = '<p class="no-tickets">No tickets found.</p>';
            }
        }
        
        // New function to update tickets with full data including descriptions
        function updateTicketsWithData(tickets) {
            if (!tickets || !tickets.length) return;
            
            tickets.forEach(ticket => {
                // Update description if available
                const descriptionEl = document.getElementById(`description-${ticket.jira_key}`);
                if (descriptionEl && ticket.description) {
                    descriptionEl.textContent = ticket.description;
                }
                
                // Update test cases if available
                if (ticket.test_cases && ticket.test_cases.length > 0) {
                    const testCasesEl = document.getElementById(`test-cases-${ticket.jira_key}`);
                    if (testCasesEl) {
                        let html = '<h4>Test Cases</h4>';
                        ticket.test_cases.forEach((testCase, index) => {
                            html += `
                                <div class="test-case" id="test-case-${testCase.id}">
                                    <div class="test-case-view">
                                        <div class="test-case-header">
                                            <h5>Test Case ${index + 1}</h5>
                                            <button class="edit-test-case-btn" onclick="editTestCase('${testCase.id}')">‚úèÔ∏è Edit</button>
                                        </div>
                                        <p><strong>Scenario:</strong> <em>${testCase.scenario}</em></p>
                                        <p><strong>Action:</strong> <em>${testCase.action}</em></p>
                                        <p><strong>Expected behavior:</strong> <em>${testCase.expected_behavior}</em></p>
                                    </div>
                                    <div class="test-case-edit" style="display: none;">
                                        <div class="test-case-header">
                                            <h5>Edit Test Case ${index + 1}</h5>
                                            <div>
                                                <button class="cancel-edit-btn" onclick="cancelEditTestCase('${testCase.id}')">Cancel</button>
                                                <button class="save-test-case-btn" onclick="saveTestCase('${testCase.id}')">Save</button>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="scenario-${testCase.id}">Scenario:</label>
                                            <textarea id="scenario-${testCase.id}" class="form-control">${testCase.scenario}</textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="action-${testCase.id}">Action:</label>
                                            <textarea id="action-${testCase.id}" class="form-control">${testCase.action}</textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="expected-${testCase.id}">Expected behavior:</label>
                                            <textarea id="expected-${testCase.id}" class="form-control">${testCase.expected_behavior}</textarea>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        testCasesEl.innerHTML = html;
                        
                        // Update the generate button to show badge
                        const actionsEl = document.querySelector(`#ticket-${ticket.jira_key} .ticket-actions`);
                        if (actionsEl) {
                            actionsEl.innerHTML = `
                                <span class="test-cases-badge">‚úÖ Test Cases Generated</span>
                                <button class="expand-button" onclick="expandTicket('${ticket.jira_key}')">‚ñº</button>
                            `;
                        }
                    }
                }
            });
        }
        
        // Initialize polling if fetch is running
        document.addEventListener('DOMContentLoaded', function() {
            const fetchStatus = document.getElementById('fetch-backlog-status').textContent;
            if (fetchStatus === 'running') {
                pollFetchStatus();
            }
        });
        
        // Function to manually add event listeners to all Jira buttons
        function addManualEventListeners() {
            console.log("üîß Adding manual event listeners to all Jira buttons");
            
            // Find all buttons with the send-to-jira-btn class
            const mainButtons = document.querySelectorAll('.send-to-jira-btn');
            console.log(`Found ${mainButtons.length} .send-to-jira-btn buttons`);
            
            mainButtons.forEach(button => {
                // Get the ticket ID from the button ID or closest ticket-item
                let ticketId = null;
                if (button.id && button.id.includes('send-to-jira-btn-')) {
                    ticketId = button.id.replace('send-to-jira-btn-', '').replace('main-', '');
                } else {
                    const ticketItem = button.closest('.ticket-item');
                    if (ticketItem && ticketItem.id) {
                        ticketId = ticketItem.id.replace('ticket-', '');
                    }
                }
                
                if (ticketId) {
                    console.log(`Adding manual click listener to button for ticket ${ticketId}`);
                    
                    // Replace the button with a completely new one using direct onclick
                    const newButton = document.createElement('button');
                    newButton.id = button.id || `send-to-jira-btn-direct-${ticketId}`;
                    newButton.className = 'send-to-jira-btn direct-button';
                    newButton.textContent = 'SEND TEST CASES TO JIRA';
                    newButton.setAttribute('data-ticket-id', ticketId);
                    
                    // Use direct onclick attribute
                    newButton.setAttribute('onclick', `sendToJira('${ticketId}'); event.stopPropagation(); return false;`);
                    
                    // Copy styling
                    newButton.style.cssText = button.style.cssText + '; position: relative; z-index: 1000; cursor: pointer !important;';
                    
                    // Replace the old button
                    if (button.parentNode) {
                        button.parentNode.replaceChild(newButton, button);
                    }
                }
            });
            
            // Find all emergency buttons too
            const emergencyButtons = document.querySelectorAll('.emergency-jira-button');
            console.log(`Found ${emergencyButtons.length} .emergency-jira-button buttons`);
            
            emergencyButtons.forEach(button => {
                // The emergency button should be inside a ticket-item
                const ticketItem = button.closest('.ticket-item');
                if (ticketItem && ticketItem.id) {
                    const ticketId = ticketItem.id.replace('ticket-', '');
                    console.log(`Adding manual click listener to emergency button for ticket ${ticketId}`);
                    
                    // Replace with a new button using direct onclick
                    const newButton = document.createElement('button');
                    newButton.className = 'emergency-jira-button direct-button';
                    newButton.textContent = 'Send to Jira';
                    newButton.setAttribute('data-ticket-id', ticketId);
                    
                    // Use direct onclick attribute
                    newButton.setAttribute('onclick', `sendToJira('${ticketId}'); event.stopPropagation(); return false;`);
                    
                    // Copy styling
                    newButton.style.cssText = button.style.cssText + '; position: relative; z-index: 1000; cursor: pointer !important;';
                    
                    // Replace the old button
                    if (button.parentNode) {
                        button.parentNode.replaceChild(newButton, button);
                    }
                }
            });
        }
    </script>
    </script>
    
    <!-- Clean button fix solution -->
    <script src="{{ url_for('static', filename='js/button-fix-clean.js') }}"></script>
</body>
</html>
